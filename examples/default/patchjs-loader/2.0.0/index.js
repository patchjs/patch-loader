!function(){"use strict";function e(){this.queue=[]}function t(e){this.url=e.url,this.onLoad=e.onLoad,this.code=null,this.reqUrl=null,this.ready=!1,this.complete=!1,this.fromCache=!1}function n(e,t){for(var n in t)e[n]=t[n];return e}function r(e,t){if(e&&/\S/.test(e)){var n="script";/\.css$/.test(t)&&(n="style");var r=document.createElement(n),i=document.createTextNode(e);r.appendChild(i),document.head.appendChild(r)}}function i(e,t){var n=new XMLHttpRequest;return n.open("GET",e,!0),n.onreadystatechange=function(){if(4===n.readyState){var r=/-\d+\.\d+\.\d+/,s=r.test(e);if(200===n.status||304===n.status)t(n.responseText,s);else if(404===n.status){if(!s)throw new Error("Not Found");i(e.replace(r,""),t)}}},n.send(null)}var s={cache:!1,increment:!1,diffCount:5,env:""};e.prototype={push:function(e){e.url?this.queue.push(e):e.wait&&this.queue.push(n(e,{complete:!1}))},update:function(e,t){for(var r=0,i=this.queue.length;r<i;r++){var s=this.queue[r];if(s.url===e){n(s,t);break}}this.roll()},roll:function(){for(var e=0,t=0,n=this.queue.length;e<n;e++){var i=this.queue[e];if(i.complete)t++;else if(i.ready&&(r(i.code,i.reqUrl),i.onLoad&&i.onLoad(i.reqUrl,i.fromCache),i.complete=!0,t++),i.wait){if(e!==t)break;"[object Function]"===Object.prototype.toString.call(i.wait)&&i.wait(),i.complete=!0,t++}}}},patchjs.config=function(t){var n=document.querySelector('meta[name="patchjs"]');if(n&&!t.version)for(var r=n.getAttribute("content"),i=r.split(","),a=0,o=i.length;a<o;a++){var c=i[a];/version=/.test(c)&&(t.version=c.split("=")[1])}this.options=t||{};for(var u in s)s.hasOwnProperty(u)&&(this.options[u]=this.options[u]||s[u]);return this.assetsManager=new e,this},patchjs.load=function(e,n){return n&&(n=n.bind(this)),this.assetsManager.push(new t({url:e,onLoad:n})),this.req(e),this},patchjs.req=function(e){var t=this.options,n=t.env+t.path+e,r=this;this.cache.get(n,function(s){s=s||{};var a=s.version,o=s.code;if(t.cache&&a===t.version&&o){var c=r.combineReqUrl(e,!1);r.assetsManager.update(e,{ready:!0,code:o,reqUrl:c,fromCache:!0})}else{var u=t.cache&&t.increment&&o&&r.withinCertainDiffRange(a),h=r.combineReqUrl(e,u,a);i(h,function(i,s){if(s){var a=JSON.parse(i),c=a.c;o=a.m?r.mergeCode(o,a.l,c):o}else o=i;r.assetsManager.update(e,{ready:!0,code:o,reqUrl:h}),t.cache&&r.cache.set(n,{code:o,version:t.version},function(e,i){if(!e){r.cache.remove(n);var s=t.exceedQuotaErr;s&&s.call(r,h,i)}})})}})},patchjs.wait=function(e){return e&&(e=e.bind(this)),this.assetsManager.push({wait:e||!0}),this},patchjs.withinCertainDiffRange=function(e){if(e){var t=/(\d+)\.(\d+)\.(\d+)/,n=this.options.version.match(t),r=e.match(t);if(n[1]===r[1]&&n[2]===r[2]&&0<n[3]-r[3]&&n[3]-r[3]<this.options.diffCount)return!0}return!1},patchjs.combineReqUrl=function(e,t,n){if(t&&n){var r=e.substring(e.lastIndexOf("."));e=e.replace(new RegExp(r+"$","i"),"-"+n+r)}var i=this.options;return i.path+i.version+"/"+e},patchjs.mergeCode=function(e,t,n){for(var r="",i=0,s=n.length;i<s;i++){var a=n[i];if("[object String]"===Object.prototype.toString.call(a))r+=a;else{var o=a[0]*t,c=a[1]*t;r+=e.substr(o,c)}}return r},patchjs.Asset=t,patchjs.AssetsManager=e}();