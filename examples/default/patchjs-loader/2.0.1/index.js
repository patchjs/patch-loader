!function(){"use strict";function t(){this.queue=[]}function e(t){this.url=t.url,this.onLoad=t.onLoad,this.code=null,this.reqUrl=null,this.ready=!1,this.complete=!1,this.fromCache=!1}function n(t,e){for(var n in e)t[n]=e[n];return t}function r(t,e){if(t&&/\S/.test(t)){var n="script";/\.css$/.test(e)&&(n="style");var r=document.createElement(n),s=document.createTextNode(t);r.appendChild(s),document.head.appendChild(r)}}function s(t,e){var n=new XMLHttpRequest;return n.open("GET",t,!0),n.onreadystatechange=function(){if(4===n.readyState){var r=/-\d+\.\d+\.\d+/,i=r.test(t);if(200===n.status||304===n.status)e(n.responseText,i);else{if(404!==n.status)throw new Error("status: "+n.status+", statusText:"+n.statusText+", url: "+t);if(!i)throw new Error("url not found: "+t);s(t.replace(r,""),e)}}},n.send(null)}var i={cache:!1,increment:!1,diffCount:5,env:""};t.prototype={push:function(t){t.url?this.queue.push(t):t.wait&&this.queue.push(n(t,{complete:!1}))},update:function(t,e){for(var r=0,s=this.queue.length;r<s;r++){var i=this.queue[r];if(i.url===t){n(i,e);break}}this.roll()},roll:function(){for(var t=0,e=0,n=this.queue.length;t<n;t++){var s=this.queue[t];if(s.complete)e++;else if(s.ready&&(r(s.code,s.reqUrl),s.onLoad&&s.onLoad(s.reqUrl,s.fromCache),s.complete=!0,e++),s.wait){if(t!==e)break;"[object Function]"===Object.prototype.toString.call(s.wait)&&s.wait(),s.complete=!0,e++}}}},patchjs.config=function(e){this.options=e||{};for(var n in i)i.hasOwnProperty(n)&&(this.options[n]=this.options[n]||i[n]);return this.assetsManager=new t,this},patchjs.load=function(t,n){return n&&(n=n.bind(this)),this.assetsManager.push(new e({url:t,onLoad:n})),this.req(t),this},patchjs.req=function(t){var e=this.options,n=e.env+e.path+t,r=this;this.cache.get(n,function(i){i=i||{};var a=i.version,o=i.code;if(e.cache&&a===e.version&&o){var c=r.combineReqUrl(t,!1);r.assetsManager.update(t,{ready:!0,code:o,reqUrl:c,fromCache:!0})}else{var u=e.cache&&e.increment&&o&&r.withinCertainDiffRange(a),h=r.combineReqUrl(t,u,a);s(h,function(s,i){if(i){var a=JSON.parse(s),c=a.c;o=a.m?r.mergeCode(o,a.l,c):o}else o=s;r.assetsManager.update(t,{ready:!0,code:o,reqUrl:h}),e.cache&&r.cache.set(n,{code:o,version:e.version},function(t,s){if(!t){r.cache.remove(n);var i=e.exceedQuotaErr;i&&i.call(r,h,s)}})})}})},patchjs.wait=function(t){return t&&(t=t.bind(this)),this.assetsManager.push({wait:t||!0}),this},patchjs.withinCertainDiffRange=function(t){if(t){var e=/(\d+)\.(\d+)\.(\d+)/,n=this.options.version.match(e),r=t.match(e);if(n[1]===r[1]&&n[2]===r[2]&&0<n[3]-r[3]&&n[3]-r[3]<this.options.diffCount)return!0}return!1},patchjs.combineReqUrl=function(t,e,n){if(e&&n){var r=t.substring(t.lastIndexOf("."));t=t.replace(new RegExp(r+"$","i"),"-"+n+r)}var s=this.options;return s.path+s.version+"/"+t},patchjs.mergeCode=function(t,e,n){for(var r="",s=0,i=n.length;s<i;s++){var a=n[s];if("[object String]"===Object.prototype.toString.call(a))r+=a;else{var o=a[0]*e,c=a[1]*e;r+=t.substr(o,c)}}return r},patchjs.Asset=e,patchjs.AssetsManager=t}();